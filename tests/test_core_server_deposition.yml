---
- name: test that the defaults are correctly placed
  hosts: localhost
  become: true
  vars:
    irods_cfg_made_changes: false
  roles:
    - role: ../../ansible-irods-cfg

  post_tasks:
    - include_tasks: tasks/validate_deposition.yml
      vars:
        cfg_path: /etc/irods/{{ item }}
        schema: "{{ item }}"
      with_items:
        - host_access_control_config.json
        - hosts_config.json
        - server_config.json

    - name: verify that database_config.json was not deposited
      stat:
        path: /etc/irods/database_config.json
      register: response
      failed_when: response.stat.exists

    - name: verify that .odbc.ini was not deposited
      stat:
        path: /var/lib/irods/.odbc.ini
      register: response
      failed_when: response.stat.exists

    - name: verify that .pgpass was not deposited
      stat:
        path: /var/lib/irods/.pgpass
      register: response
      failed_when: response.stat.exists
      
    - include_tasks: tasks/validate_deposition.yml
      vars:
        cfg_path: /var/lib/irods/.irods/irods_environment.json
        schema: service_account_environment.json

    - include_tasks: tasks/validate_deposition.yml
      vars:
        cfg_path: /var/lib/irods/.irods/irods_environment.json
        schema: ansible-irods-cfg/test/irods_grid_environment.json
        local_schema_file: yes

    - name: check service_account.config deposition
      stat:
        path: /etc/irods/service_account.config
      register: response
      failed_when: >
        not response.stat.exists or
        response.stat.pw_name != 'irods' or
        response.stat.gr_name != 'irods'

    - include_tasks: tasks/verify_change_notified.yml
