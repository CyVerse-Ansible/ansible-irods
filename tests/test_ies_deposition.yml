---
- name: verify IES specific files are in place are correct
  hosts: localhost
  become: true
  vars:
    irods_cfg_made_changes: false
  vars_files:
    - vars/database_config_opts.yml
  roles:
    - role: ../../ansible-irods-cfg

  post_tasks:
    - import_tasks: tasks/validate_deposition.yml
      vars:
        cfg_path: /etc/irods/database_config.json
        schema: database_config.json

    - name: check .pgpass deposition
      stat:
        path: /var/lib/irods/.pgpass
      register: response
      failed_when: >
        not response.stat.exists or
        response.stat.pw_name != 'irods' or
        response.stat.gr_name != 'irods' or
        not response.stat.rusr or
        response.stat.rgrp or response.stat.wgrp or response.stat.xgrp or
        response.stat.roth or response.stat.woth or response.stat.xoth

    - name: check .odbc.ini deposition
      stat:
        path: /var/lib/irods/.odbc.ini
      register: response
      failed_when: >
        not response.stat.exists or
        response.stat.pw_name != 'irods' or
        response.stat.gr_name != 'irods'

    - name: verify .odbc.ini contents
      assert:
        that:
          - "lookup('ini', 'driver section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini')
              == 'PostgreSQL12'"
          - "lookup('ini', 'Description section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini')
              == 'iRODS Catalog'"
          - "lookup('ini', 'Servername section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini') \
              == 'icat.domain'"
          - lookup('ini', 'Port section="iRODS Catalog" file=/var/lib/irods/.odbc.ini') == '1'
          - "lookup('ini', 'Database section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini')
              == 'db'"
          - lookup('ini', 'CommLog section="iRODS Catalog" file=/var/lib/irods/.odbc.ini') == '0'
          - lookup('ini', 'Debug section="iRODS Catalog" file=/var/lib/irods/.odbc.ini') == '0'
          - "lookup('ini', 'FakeOidIndex section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini') \
              == 'No'"
          - lookup('ini', 'Ksqo section="iRODS Catalog" file=/var/lib/irods/.odbc.ini') == '0'
          - lookup('ini', 'ReadOnly section="iRODS Catalog" file=/var/lib/irods/.odbc.ini') == 'No'
          - "lookup( \
                'ini', 'RowVersioning section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini') \
              == 'No'"
          - "lookup( \
                'ini', 'ShowOidColumn section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini') \
              == 'No'"
          - "lookup(\
                'ini', 'ShowSystemTables section=\"iRODS Catalog\" file=/var/lib/irods/.odbc.ini') \
              == 'No'"

    - include_tasks: tasks/verify_change_notified.yml
